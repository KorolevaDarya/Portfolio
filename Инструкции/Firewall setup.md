## Настройка межсетевого экрана на сервере под управлением RedHat Linux

Для настройки межсетевого экрана на сервере под управлением RedHat Linux используйте утилиту **iptables**.

### 1. Установка iptables

#### 1.1. Проверьте наличие iptables:
```
iptables -V
```

Если версия отображается, то iptables уже установлен.

#### 1.2. Переключитесь на пользователя root:
```
sudo su
```

#### 1.3. Установите и активируйте iptables, если он отсутствует:
```
yum install iptables -y
systemctl start iptables
```

### 2. Правила обработки трафика

Iptables использует таблицы для определенных наборов задач. Основная таблица **filter** служит для фильтрации пакетов и используется по умолчанию, если явно не указано имя другой таблицы. Она содержит цепочки – последовательности правил, которые определяют, как будет обработан трафик:

- **INPUT** – контролирует входящие соединения.
- **FORWARD** – используется для перенаправления пакетов.
- **OUTPUT** – контролирует исходящие соединения.

Основные действия с цепочками:

- **ACCEPT** – разрешить соединение.
- **DROP** – игнорировать соединение (источник запроса не узнает о его блокировке).
- **REJECT** – заблокировать соединение и отправить сообщение об ошибке.

### 3. Очистка действующих правил

Сбросьте настройки всех цепочек до исходного состояния:
```
iptables -F
```

### 4. Установка правил по умолчанию

Разрешите все входящие и исходящие соединения:
```
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT
```

**Предупреждение**: Лучше разрешить все входящие/исходящие соединения и затем выставлять запреты под конкретные порты и IP-адреса, чтобы избежать блокировки доступа к серверу.

### 5. Определение правил для конкретных соединений

Синтаксис команды для добавления нового правила:
```
iptables [-t таблица] -A <цепочка> <критерии> -j <действие>
```

Где:
- **[-t таблица]** – название таблицы (по умолчанию используется таблица filter);
- ключ **-A** добавляет новое правило в конец указанной цепочки;
- **<цепочка>** - название цепочки, в которую добавляется правило;
- **<критерии>** - критерии, которыми должен обладать пакет, чтобы к нему применилось действие;
- ключ **-j** определяет действие, выполняемое для указанных критериев;
- **<действие>** - указывает, что утилита должна сделать с пакетом, попавшим под указанные критерии.

#### 5.1. Настройка трафика для установленных соединений

Разрешите трафик для уже установленных соединений и связанных с ними пакетов:
```
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
```
Ключ **-m** загружает модуль state, который определяет текущее состояние пакета:

- **NEW** – относится к входящим пакетам, участвующим в установке соединения;
- **ESTABLISHED и RELATED** – относится к входящим пакетам, участвующим в уже установленных соединениях;
- **INVALID** — относится к входящим пакетам, если к ним не применимо ни одно из указанных выше состояний.

#### 5.2. Настройка ICMP-трафика

Разрешите следующие соединения:
- ICMP Echo Request (тип 8) для проверки состояния сетевого соединения с вашим сервером (ping);
- ICMP Time Exceeded (тип 11) для диагностики маршрутизации и сетевых проблем.

```
-A INPUT -p icmp --icmp-type 8 -j ACCEPT
-A INPUT -p icmp --icmp-type 11 -j ACCEPT
```

#### 5.3. Настройка трафика от локального интерфейса

Разрешите трафик от локального интерфейса:
```
-A INPUT -i lo -j ACCEPT
```

#### 5.4. Открытие порта для SSH-доступа

Разрешите подключение через SSH (порт 22) только с определенного IP-адреса (замените `100.100.100.100` на нужный вам IP):
```
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -s 100.100.100.100 -j ACCEPT
```
Учитывайте тип протокола для передачи данных (tcp, udp).

#### 5.5. Настройка соединений с определенного IP-адреса

Разрешите трафик с указанного IP (замените `200.200.200.200` на нужный вам IP):
```
-A INPUT -m state --state NEW -m udp -p udp -s 200.200.200.200 -j ACCEPT
```

Для диапазона IP-адресов используйте маски:
```
-A INPUT -m state --state NEW -m udp -p udp -s 192.168.0.0/16 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s 192.168.0.0/16 -j ACCEPT
```

#### 5.6. Настройка правил для остального трафика

Запретите все входящие и перенаправленные пакеты, которые не подходят ни под одно из предыдущих правил:
```
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
```

### 6. Проверка текущей конфигурации

Выведите все действующие правила:
```
iptables --line-numbers -L -v -n
```

Если требуется, удалите конкретное правило:
```
iptables –D <цепочка> <номер строки>
```

### 7. Сохранение правил

#### 7.1 Установите и активируйте пакет iptables-services:
```
yum install iptables-services
systemctl enable iptables
```

#### 7.2 Проверьте статус сервиса:
```
systemctl status iptables
```

Должны получить `enabled (включен), active (запущен)`.

#### 7.3 Сохраните настройки в файл:
```
iptables-save > /etc/sysconfig/iptables
```

#### 7.4 Перезагрузите iptables:
```
systemctl restart iptables
```

### 8. Завершение работы

Выйдите из пользователя root:
```
exit
```
